<div class="p-8">
  <div class="max-w-7xl mx-auto bg-white rounded-2xl shadow-xl overflow-hidden">

    <!-- Header -->
    <div class="p-8 border-b border-gray-200">
      <h2 class="text-3xl font-semibold text-blue-900 mb-2">Búsqueda de Trazabilidad</h2>
      <p class="text-gray-600">Consulta el historial de cambios de un usuario específico</p>
    </div>

    <!-- Search Section -->
    <div class="p-8 bg-gray-50 border-b border-gray-200">
      <div class="space-y-4">
        <label for="nombreUsuario" class="block text-sm font-semibold text-gray-700">
          Nombre del Usuario
        </label>
        <input
          type="text"
          id="nombreUsuario"
          [(ngModel)]="nombreUsuario"
          name="nombreUsuario"
          class="w-full px-4 py-3 border-2 border-gray-300 rounded-lg text-base focus:outline-none focus:border-blue-900 focus:ring-0 transition-colors"
          placeholder="Ingrese el nombre del usuario a buscar..."
          (keyup.enter)="buscarTrazabilidad()"
        />
        <div class="flex gap-4">
          <button
            type="button"
            class="px-6 py-3 bg-blue-900 text-white rounded-lg hover:bg-blue-800 disabled:opacity-50 disabled:cursor-not-allowed transition-colors font-medium"
            (click)="buscarTrazabilidad()"
            [disabled]="loading || !nombreUsuario.trim()"
          >
            {{ loading ? 'Buscando...' : 'Buscar Trazabilidad' }}
          </button>
          <button
            type="button"
            class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 hover:border-gray-400 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed"
            (click)="limpiarBusqueda()"
            [disabled]="loading"
          >
            Limpiar
          </button>
        </div>
      </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="p-12 text-center">
      <div class="text-gray-600 font-medium text-lg">Buscando trazabilidad del usuario...</div>
      <div class="text-gray-400 text-sm mt-2">Esto puede tomar unos momentos</div>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="p-12 text-center">
      <div class="text-red-600 font-medium text-lg mb-4">{{ error }}</div>
      <button
        class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
        (click)="limpiarBusqueda()"
      >
        Intentar nuevamente
      </button>
    </div>

    <!-- User Info -->
    <div *ngIf="trazabilidadUsuario && !loading && !error" class="p-8 bg-blue-900 text-white border-b border-gray-200">
      <div class="flex items-center gap-6">
        <div class="w-16 h-16 bg-white bg-opacity-20 rounded-lg flex items-center justify-center">
          <svg class="w-8 h-8 text-white" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div>
          <h3 class="text-2xl font-bold mb-1">{{ trazabilidadUsuario.nombre }}</h3>
          <p class="text-blue-100 mb-2">{{ trazabilidadUsuario.correo }}</p>
          <span class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm font-medium">
            {{ trazabilidadUsuario.rol }}
          </span>
        </div>
      </div>
    </div>

    <!-- Incidentes Section -->
    <div *ngIf="trazabilidadUsuario && !loading && !error" class="p-8 border-b border-gray-200">
      <h4 class="text-xl font-bold mb-6 text-blue-900">Incidentes reportados</h4>
      <div *ngIf="incidentes.length === 0" class="text-gray-500 py-6 text-center">No hay incidentes registrados.</div>
      <div *ngFor="let item of incidentes" class="border border-gray-200 rounded-lg p-6 mb-4 hover:bg-gray-50 transition-colors">
        <div class="font-semibold text-blue-800 mb-2">Descripción: {{ item.incidente.descripcion }}</div>
        <div class="text-sm text-gray-600 mb-2">Fecha: {{ formatDate(item.incidente.fecha_reporte) }}</div>
        <div class="text-sm text-gray-600 mb-2">Estado actual: {{ item.incidente.estadoId }}</div>
        <div *ngIf="item.trazabilidad.length > 0" class="mt-4">
          <h5 class="font-bold text-gray-700 mb-2">Trazabilidad:</h5>
          <ul class="list-disc ml-6 space-y-1">
            <li *ngFor="let t of item.trazabilidad" class="text-sm">
              <span class="font-medium">{{ formatDate(t.fecha_cambio) }}:</span>
              <span>De <strong>{{ t.estado_anterior || 'N/A' }}</strong> a <strong>{{ t.estado_nuevo }}</strong></span>
            </li>
          </ul>
        </div>
        <div *ngIf="item.trazabilidad.length === 0" class="text-gray-400 mt-2">Sin trazabilidad registrada.</div>
      </div>
    </div>

    <!-- Objetos Perdidos Section -->
    <div *ngIf="trazabilidadUsuario && !loading && !error" class="p-8 border-b border-gray-200">
      <h4 class="text-xl font-bold mb-6 text-purple-900">Objetos perdidos reportados</h4>
      <div *ngIf="objetosPerdidos.length === 0" class="text-gray-500 py-6 text-center">No hay objetos perdidos registrados.</div>
      <div *ngFor="let item of objetosPerdidos" class="border border-gray-200 rounded-lg p-6 mb-4 hover:bg-purple-50 transition-colors">
        <div class="font-semibold text-purple-800 mb-2">Objeto: {{ item.objeto_perdido.nombre_objeto }}</div>
        <div class="text-sm text-gray-600 mb-2">Descripción: {{ item.objeto_perdido.descripcion }}</div>
        <div class="text-sm text-gray-600 mb-2">Fecha: {{ formatDate(item.objeto_perdido.fecha_perdida) }}</div>
        <div class="text-sm text-gray-600 mb-2">Estado actual: {{ item.objeto_perdido.estadoId }}</div>
        <div *ngIf="item.trazabilidad.length > 0" class="mt-4">
          <h5 class="font-bold text-gray-700 mb-2">Trazabilidad:</h5>
          <ul class="list-disc ml-6 space-y-1">
            <li *ngFor="let t of item.trazabilidad" class="text-sm">
              <span class="font-medium">{{ formatDate(t.fecha_cambio) }}:</span>
              <span>De <strong>{{ t.estado_anterior || 'N/A' }}</strong> a <strong>{{ t.estado_nuevo }}</strong></span>
              <span *ngIf="t.comentario" class="text-gray-500"> - <em>{{ t.comentario }}</em></span>
            </li>
          </ul>
        </div>
        <div *ngIf="item.trazabilidad.length === 0" class="text-gray-400 mt-2">Sin trazabilidad registrada.</div>
      </div>
    </div>


      <!-- Sin cambios -->


      <!-- Lista de cambios -->
      <div *ngIf="cambiosEstados.length > 0" class="space-y-4">
        <div
          *ngFor="let cambio of cambiosEstados; trackBy: trackByIndex"
          class="border border-gray-200 rounded-lg p-6 hover:bg-gray-50 transition-colors"
          [ngClass]="getEntityClass(cambio.tipo_entidad)"
        >
          <!-- Header del cambio -->
          <div class="flex items-center gap-4 mb-4">
            <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center">
              <ng-container [ngSwitch]="cambio.tipo_entidad">
                <svg *ngSwitchDefault class="w-6 h-6 text-gray-600" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M14 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V8L14 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M14 2V8H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <svg *ngSwitchCase="'usuario'" class="w-6 h-6 text-gray-600" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M20 21V19C20 17.9391 19.5786 16.9217 18.8284 16.1716C18.0783 15.4214 17.0609 15 16 15H8C6.93913 15 5.92172 15.4214 5.17157 16.1716C4.42143 16.9217 4 17.9391 4 19V21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <circle cx="12" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <svg *ngSwitchCase="'incidente'" class="w-6 h-6 text-gray-600" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M10.29 3.86L1.82 18C1.64571 18.3024 1.55299 18.6453 1.55201 18.9945C1.55103 19.3437 1.64171 19.6871 1.81442 19.9905C1.98714 20.2939 2.23584 20.5468 2.53621 20.7239C2.83658 20.901 3.18035 20.9962 3.53 21H20.47C20.8197 20.9962 21.1634 20.901 21.4638 20.7239C21.7642 20.5468 22.0129 20.2939 22.1856 19.9905C22.3583 19.6871 22.449 19.3437 22.448 18.9945C22.447 18.6453 22.3543 18.3024 22.18 18L13.71 3.86C13.5317 3.56611 13.2807 3.32312 12.9812 3.15448C12.6817 2.98585 12.3438 2.89725 12 2.89725C11.6562 2.89725 11.3183 2.98585 11.0188 3.15448C10.7193 3.32312 10.4683 3.56611 10.29 3.86V3.86Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M12 9V13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M12 17H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </ng-container>
            </div>
            <div>
              <div class="font-bold text-gray-800 capitalize">{{ cambio.tipo_entidad }}</div>
              <div class="text-sm text-gray-500">{{ formatDate(cambio.fecha_cambio) }}</div>
            </div>
          </div>

          <!-- Cambio de estado -->
          <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <div class="flex items-center justify-center gap-4">
              <div class="text-center">
                <p class="text-xs text-gray-500 mb-1">Estado Anterior</p>
                <span class="bg-gray-200 text-gray-700 px-3 py-1 rounded-lg text-sm font-medium">
                  {{ cambio.estado_anterior || 'N/A' }}
                </span>
              </div>
              <div class="text-gray-400">→</div>
              <div class="text-center">
                <p class="text-xs text-gray-500 mb-1">Estado Nuevo</p>
                <span class="bg-blue-900 text-white px-3 py-1 rounded-lg text-sm font-medium">
                  {{ cambio.estado_nuevo || 'N/A' }}
                </span>
              </div>
            </div>
          </div>

          <!-- Comentario -->
          <div *ngIf="cambio.comentario" class="bg-blue-50 border-l-4 border-blue-500 rounded-r-lg p-4">
            <p class="text-sm font-semibold text-gray-700 mb-1">Comentario:</p>
            <p class="text-gray-600">{{ cambio.comentario }}</p>
          </div>
        </div>
      </div>
    </div>
  </div>

